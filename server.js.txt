const express = require('express');
const { GoogleGenAI } = require('@google/genai');
const cors = require('cors');

// Initialize the Express app
const app = express();
// Vercel or local environment variable PORT
const port = process.env.PORT || 3000;

// IMPORTANT: Allow requests from your Firebase domain. Replace with your actual domain!
// If your Firebase URL is https://vidyaayaanam.web.app, use that here.
// For now, we'll keep it open for testing ('*').
app.use(cors({ origin: '*' })); 

// Middleware to parse incoming JSON data from the frontend
app.use(express.json());

// Initialize the Gemini AI client
// It securely reads the GEMINI_API_KEY from the environment variables set on Vercel.
const ai = new GoogleGenAI({ apiKey: process.env.GEMINI_API_KEY }); 

// Health check route for Vercel
app.get('/', (req, res) => {
    res.send({ status: 'AI Proxy Server is Running' });
});


// POST endpoint that the frontend calls
app.post('/generate-content', async (req, res) => {
    // Basic check for the secret key
    if (!process.env.GEMINI_API_KEY) {
        return res.status(500).send({ success: false, error: 'Server API Key not configured. Please set GEMINI_API_KEY on Vercel.' });
    }

    const { resourceType, medium, selectedClass, selectedSubject, selectedTopic, userQuery } = req.body;
    
    // The FINAL Prompt for Minimalist Modern Style
    const fullPrompt = `You are an expert educational content generator named Vidyaayaanam. 
    Create a ${resourceType} for Class ${selectedClass}, Subject ${selectedSubject}, Topic ${selectedTopic}. 
    The content should be in ${medium} language.
    Format the output in a **minimalist, modern, and easy-to-read style**. 
    Use clear headings (using ## and ###), bullet points, and short, professional paragraphs. Avoid overly decorative or conversational intros/outros.
    User Request/Query: "${userQuery}".`;

    try {
        const model = ai.getGenerativeModel({ model: "gemini-2.5-flash" });
        const result = await model.generateContent(fullPrompt);
        const response = await result.response;
        const text = response.text; // Use response.text for the final result

        res.send({ success: true, content: text });

    } catch (error) {
        console.error("Gemini API Error:", error.message);
        res.status(500).send({ success: false, error: 'Failed to generate content due to a backend error. Check Vercel logs.' });
    }
});

// Start the server
app.listen(port, () => {
    console.log(`AI Proxy Server listening on port ${port}`);
});